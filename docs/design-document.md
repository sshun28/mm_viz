# マイクロマウスビジュアライザー設計ドキュメント

## 1. 概要

### 1.1 プロジェクトの目的
このプロジェクトは、マイクロマウスの迷路探索をリアルタイムで可視化するためのReactコンポーネントを提供することを目的としています。マイクロマウスの動きや探索アルゴリズムの挙動を直感的に理解しやすくするツールを構成するためのコンポーネントライブラリです。

### 1.2 主要な機能
- マイクロマウスの迷路の3D表示
- 迷路内に配置するオブジェクト（マウス、軌跡など）の描画基盤
- 壁や経路の視覚的表現
- カメラコントロール（ズーム、回転、パン）

### 1.3 技術スタック
- **React**: UIコンポーネント構築
- **TypeScript**: 型安全な開発
- **Three.js/React Three Fiber**: 3Dレンダリング
- **React Three Drei**: Three.jsの便利なヘルパー
- **Storybook**: コンポーネント開発・テスト環境

## 2. コンポーネント構成

### 2.1 MicromouseVisualizer（メインコンポーネント）
メインのコンテナコンポーネント。3Dシーンのセットアップ、迷路の描画、カメラ制御を担当します。迷路内に表示する他の要素（マウス、軌跡など）は `children` として受け取ります。

**Props:**
- `mazeData?: MazeData`: 迷路データ。提供されない場合はローディング表示。
- `width?: number`: コンポーネントの幅 (デフォルト: 800)。
- `height?: number`: コンポーネントの高さ (デフォルト: 600)。
- `backgroundColor?: string`: 背景色 (デフォルト: '#f0f0f0')。
- `showGridHelper?: boolean`: グリッドヘルパーの表示/非表示 (デフォルト: false)。
- `showAxesHelper?: boolean`: 軸ヘルパーの表示/非表示 (デフォルト: false)。
- `initialViewPreset?: CameraViewPreset`: 初期カメラビュープリセット (デフォルト: 'angle')。
- `children?: React.ReactNode`: 迷路内に描画する追加のReact要素（例: `<Mouse />`, `<Trajectory />`）。

### 2.2 サブコンポーネント (MicromouseVisualizer 内部)
#### 2.2.1 Maze
- `mazeData: MazeData` を prop として受け取る。
- 迷路の床・柱・壁を描画。
- 壁の存在有無を視覚的に表現。
- スタート地点とゴール地点を強調表示。

#### 2.2.2 CameraController
- `initialViewPreset: CameraViewPreset`, `mazeSize: number`, `target: [number, number, number]` を prop として受け取る。
- OrbitControls を使用したカメラ操作を提供。
- プリセットビューへの切り替え機能。
- カメラのターゲットを迷路の中心に設定。

### 2.3 描画要素コンポーネント (children として渡す想定)
#### 2.3.1 Mouse
- `mouseState: MouseState` を prop として受け取る。
- マウスの3Dモデルを描画。
- `mouseState` に基づいて位置と向きを更新。
- 移動アニメーションは上位コンポーネントまたは状態管理ライブラリで制御。

#### 2.3.2 Trajectory (将来実装)
- 軌跡を描画。
- 節点と線で描画。
- カラーマップ機能。

### 2.4 ControlPanel (ライブラリ外部)
このコンポーネントライブラリの範疇外。利用側で実装することを想定。
- アニメーション速度調整
- 表示/非表示設定

## 3. データ構造

詳細は [データ構造](./data-structures.md) を参照してください。

## 4. 主要な機能の実装方針

### 4.0 座標系

本ビジュアライザーでは以下の座標系を定義する。

- **セル座標**: 迷路のマス目を表す整数座標 (x, y)。左下のマスが (0, 0) となり、右に行くほどxが増加、奥に行くほどyが増加する。
- **物理座標**: Three.js空間内のメートル単位の座標 (x, y, z)。
    - **原点**: `MicromouseVisualizer` コンポーネント内の3Dシーンの原点 (0, 0, 0) は、迷路の最も左下にある区画（セル(0,0)）の、さらに左手前（-X, -Y方向）のコーナーに対応する。`Maze` コンポーネントはこの原点を基準に描画される。
    - **XY平面**: 迷路の床面と平行な平面。
    - **Z軸**: 床面に対して垂直上向きを正とする。
    - **セルと物理座標の関係**: セル座標 (cx, cy) の中心に対応する物理座標は `(cx * CELL_SIZE + CELL_SIZE / 2, cy * CELL_SIZE + CELL_SIZE / 2, 0)` となる。
    - **マウスの状態**: `MouseState` の `position` は、迷路の原点 (左下隅) を基準とした物理座標 (x, y) を示す。`Mouse` コンポーネントはこの座標に基づいて自身の位置を設定する。

### 4.1 迷路の描画方法 (`Maze` コンポーネント)
- 床面は1つの直方体として描画。
- 壁はFBXモデルを読み込み、InstancedMesh を使用して描画。
- 柱もFBXモデルを読み込み、InstancedMesh を使用して描画。

### 4.2 マウスの動きのアニメーション (ライブラリ外部)
- `MicromouseVisualizer` はマウスの状態 (`MouseState`) を直接管理しない。
- アニメーションロジック（状態の更新、補間など）は、`MicromouseVisualizer` を利用する側のアプリケーションで実装する。
- 時系列プロファイルを読み込み、`Mouse` コンポーネントに渡す `mouseState` を更新することでアニメーションを実現する。

### 4.3 壁の表現方法 (`Maze` コンポーネント)
- 外壁と内壁を区別して描画。
- （将来）発見済み/未発見の壁の表示を区別（色や透明度）。

### 4.4 カメラ制御 (`CameraController` コンポーネント)
- OrbitControlsを使用した自由なカメラ操作。
- プリセットビュー（トップビュー、斜めビュー等）。
- 迷路サイズに応じた自動ズーム調整（ターゲットを迷路中心に設定）。

## 5. インターフェース設計

詳細は [インターフェース設計](./interface-design.md) を参照してください。

## 6. 拡張性と今後の計画

### 6.1 カスタマイズオプション
- **描画要素の追加**: `children` prop を通じて、ユーザー定義の3Dオブジェクトを迷路内に追加可能。
- **マウスモデルの変更**: `Mouse` コンポーネント自体を差し替えるか、`Mouse` コンポーネントにモデル指定の prop を追加することで対応可能。

### 6.2 パフォーマンス最適化
- **描画の最適化**:
  - インスタンシングによる壁・柱の描画。
- **レンダリング設定**:
  - WebGLレンダラーの設定調整（アンチエイリアス、シャドウなど）。

## 7. テスト計画

詳細は [テスト計画](./testing-plan.md) を参照してください。

## 8. 実装スケジュール (更新)

### 8.1 フェーズ1：基本機能実装 (完了)
- **迷路レンダリング**:
  - 基本的な床面と壁・柱の描画 (`Maze` コンポーネント)
  - グリッド/軸ヘルパーの実装
- **マウス表示**:
  - 基本的な3Dモデルの実装 (`Mouse` コンポーネント)
  - 位置・角度の設定機能 (`mouseState` prop)
- **カメラコントロール**:
  - OrbitControlsの実装 (`CameraController` コンポーネント)
  - プリセットビューの実装
- **コンポーネント構造**:
  - `MicromouseVisualizer` が `children` を受け入れるように変更

### 8.2 フェーズ2：インタラクティブ機能 (ライブラリ外部/利用側)
- **アニメーション制御**:
  - 時系列プロファイルのロード機能
  - 再生・一時停止・停止機能
  - 速度調整機能
- **軌跡表示**:
  - `Trajectory` コンポーネントの実装 (children として渡す)

### 8.3 フェーズ3：高度な機能と最適化
- **パフォーマンス最適化**:
  - 大規模迷路への対応
- **拡張機能**:
  - 複数マウス表示 (複数の `<Mouse>` を children として渡す)

## 9. 参考情報

詳細は [参考情報](./reference.md) を参照してください。
